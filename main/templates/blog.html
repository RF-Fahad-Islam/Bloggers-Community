{% extends 'layout.html' %}
{% from 'includes/macros.html' import render_user_profile %}
{% block meta %}
<meta name="description" content="{{summary}}">
<meta name="keywords" content="{{post.tag}}">
<meta property="og:title" content="{{post.title}}" />
<meta property="og:type" content="blog" />
<meta property="og:url" content="{{params['app_url']}}/b/{{user.username}}/{{post.slug}}" />
{% if thumbnail or thumbnail != "" %}
<meta property="og:image" content="{{post.cover_src}}" />
{% endif %}
<meta property="og:site_name" content="{{params['app_name']}}" />
<meta property="og:description" content="{{summary}}" />
{% endblock meta %}
{% block title %}
<!-- !Share This Plugin -->
<script type="text/javascript"
  src="https://platform-api.sharethis.com/js/sharethis.js#property=637860466fa502001965e9b3&product=inline-reaction-buttons&source=platform"
  async="async"></script>
<!-- !Prisma CSS & JS-->
<link rel="stylesheet" href="{{url_for( 'static',filename='prism/prism.css')}}">
<title>{{post.title}} @{{post.writer.username}}</title>
{% endblock title %}
{% block body %}
<div id="main" class="container-fluid my-3" style="width: 90%; margin:auto;">

  <div class="row g-3">
    <!-- !Blog Section -->
    <div class="col-lg-9">
      <div class="card">
        <div class="card-body">
          {% if current_user.is_admin %}
          <a class="btn btn-outline-danger ml-2 rounded-circle float-end delete" id="/delete/b/{{post.sno}}"><i
              class="fa fa-trash"></i></a>
          {% endif %}
          {% if current_user.sno == user.sno %}
          <a class="btn btn-outline-success mr-2 rounded-circle float-end" href="/blog-writer/edit/{{post.sno}}"><i
              class="fa fa-pencil"></i></a>
          <!-- *Bookmark -->
          {% endif %}

          {% if not current_user.is_anonymous %}
          {% set cnt = current_user.readinglist.blogs.count(post) %}
          {% if cnt>0 %}
          <span class="text-primary btn btn-outline-primary hover-btn border-0" style="cursor: pointer;font-size:30px; "
            id="bookmark">
            <i class="fa fa-bookmark"></i>
          </span>
          <b id="count"></b>
          {% else %}
          <span class="text-primary hover-btn" style="cursor: pointer; font-size:30px;" id="bookmark">
            <i class="fa fa-bookmark-o"></i>
          </span>
          {% endif %}
          {% endif %}
          <h1 class="fw-bolder border-primary text-center">
            {{post.title}}
          </h1>
          <hr>
          <div class='mb-2'>
            {% for tag in post.tags_list %}
            <a href="/search?q={{tag}}&type=tag"
              class="text-black text-decoration-none fw-bolder p-2 badge bg-warning rounded-pill text-dark">#{{tag}}
            </a>
            {% endfor %}
            <button type="button"
              class="text-black text-decoration-none fw-bolder p-2 badge bg-light border-0 rounded-pill text-dark float-end"
              data-bs-toggle="modal" data-bs-target="#exampleModal">
              <i class="fa fa-link" style="font-size: 15px;"></i>
            </button>
            <a type="button" href="#comment"
              class="text-black text-decoration-none fwpop p-2 badge hover-btn border-0 rounded-pill text-dark float-end">
              <i class="fa fa-comment-o" style="font-size: 15px;">
                <b>{{comments|length+comments.replies|length}}</b></i>
            </a>
          </div>
          <!-- Button trigger modal -->

          <!-- Modal -->
          <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h1 class="modal-title fs-5" id="exampleModalLabel"> <i class="fa fa-link"></i> Share shorten link
                  </h1>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="card">
                    <div class="card-title">
                      <h4 class="text-center">Shorten Url</h4>
                    </div>
                    <input type="text" class="form-control d-block" value="{{shorturl}}" id="surl" disabled>
                  </div>
                </div>
                <a href="https://publishers.adsterra.com/referral/dJhxetn3AL"><img alt="banner"
                    src="https://landings-cdn.adsterratech.com/referralBanners/png/700%20x%2090%20px.png" /></a>
                <div class="modal-footer">
                  <button type="button" class="btn btn-primary" onclick="copy()">Copy</button>
                </div>
              </div>
            </div>
          </div>

          <!-- TODO:!Article -->
          <hr>
          <article id="body" class="blog-post position-sticky" style="top: 2rem; height:auto;">
            <div class="mb-2">
              <div class="fb-like float-end" data-href="/b/{{user.username}}/{{post.slug}}" data-width=""
                data-layout="button_count" data-action="like" data-size="large" data-share="false"></div>
              {% if user.profile == None %}
              <img src="{{url_for('static', filename='images/usericon.png')}}" alt="Avatar" width="30" height="30">
              {% else %}
              <img src="{{user.picture}}" style="border-radius: 50%;" alt="avatar" width="30" height="30">
              {% endif %}
              <a href="/p/{{user.username}}" class="link fw-bolder text-decoration-none">
                @{{user.username}}
              </a>
              <div class="d-inline-block mt-1">
                <h6 class="text-dark text-muted fw-bolder">
                  <span class="badge p-2 rounded-pill mr-2 bg-light text-black">
                    {{post.pub_date.strftime("%b %d, %Y")}}
                  </span>
                  <span class="badge p-2 rounded-pill bg-light text-black">
                    <i class="fa fa-eye"></i> {{post.views}} views
                  </span>
                </h6>
              </div>
            </div>
            {{post.body | safe}}
            <div class="sharethis-inline-reaction-buttons"></div>
            <br>
          </article>

          <nav class="blog-pagination my-3" aria-label="Pagination">
            {% if prev_post %}
            <a class="btn btn-outline-primary float-start" href="/b/{{user.username}}/{{prev_post.slug}}"> <i
                class="fa fa-arrow-left"></i> Previous</a>
            {% endif %}
            {% if next_post %}
            <a class="btn btn-outline-primary float-end" href="/b/{{user.username}}/{{next_post.slug}}">Next <i
                class="fa fa-arrow-right"></i> </a>
            {% endif %}
        </div>
        </nav>


      </div>
      <!-- !Comment Section -->

      <!-- !Community Post -->
      <!-- ../particles/comment/html -->
      <hr>
      <section class="card text-center border-0">
        <h3 class="fwpop bg-light card-header text-center"><i class="fa fa-comments-o"></i> All Comments
          ({{comments|length}})</h3>
        <div class="card-body">

          {% if current_user.is_authenticated %}
          <form method="POST" hx-post="/comment" hx-swap="beforebegin" hx-indicator="#spinner" hx-target="#comments">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <div class="d-flex mb-2 justify-content-center align-content-start align-items-start" id="comment"
              style="cursor: auto;">
              <img src="{{current_user.picture}}" width="35" height="35" class="rounded-circle mt-2">
              <div class="bg-grey text-start comment" id="commentbox">
                <div class="form-floating">
                  <textarea class="form-control " minlength="3" maxlength="300" name="body" id="tbody"
                    placeholder="Leave a comment here" id="floatingTextarea"></textarea>
                  <label for="floatingTextarea">Leave a comment</label>
                </div>
                <div class="d-flex justify-content-end align-content-center">
                  <button type="submit" id="sendbtn" class="btn btn-outline-primary d-none mt-2"><i
                      class="fa fa-commenting-o"></i> Send</button>
                </div>
              </div>
              <br>
            </div>

            <input type="hidden" name="post_id" value="{{post.sno}}">
            <input type="hidden" name="url" value="/b/{{user.username}}/{{post.slug}}">
            <input type="hidden" name="uid" value="{{current_user.userid}}">
        </div>
        <div>
          </form>
          {% else %}
          <div class="d-flex justify-content-center align-content-center text-center">
            <a href="{{url_for('googleLogin')}}" type="btn my-3 text-decoration-none button ml-3"
              style="border-radius: 50px;text-decoration:none;" class="login-with-google-btn">
              Continue with Google
            </a>
          </div>
          {% endif %}
          <div id="spinner" class="htmx-indicator spinner-border text-center" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>

        </div>
        <div id="comments">
          {% for comment in comments %}
          <div id="comment">
            <div class="d-flex mb-2 justify-content-center align-content-start align-items-start" style="cursor: auto;">
              <img src="{{comment.commentor.picture}}" width="35" height="35" class="rounded-circle mt-2">
              <div class="card bg-grey text-start border-1 comment">
                <div class="d-flex justify-content-between">

                  <a href="{{url_for('userProfile', username=comment.commentor.username)}}"
                    class="text-muted text-decoration-none text-sm-start mb-1"
                    style=" margin:0;"><b>{{comment.commentor.firstname}} {{comment.commentor.lastname}} </b>-
                    {{comment.time_ago}}</a>
                    <div class="dropdown">
                      <span class="p-2 rounded-circle link hover-btn"  data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fa fa-ellipsis-h"></i>
                      </span>
                    
                      <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{{url_for('user_comment', comsno=comment.sno, username=comment.commentor.username)}}">Open Thread</a></li>
                      </ul>
                    </div>
                </div>
                {{comment.body|safe}}

                <div class="reply">
                  {% if current_user.is_authenticated %}

                  <div class="replyinput mt-2 d-none" id="replyinput{{comment.sno}}">
                    <form method="POST" hx-post="/comment" hx-swap="beforebegin" hx-target="#addreply{{comment.sno}}">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                      <div class="d-flex mb-2 justify-content-center align-content-center align-items-start"
                        id="comment" style="cursor: auto;">
                        <img src="{{current_user.picture}}" width="35" height="35" class="rounded-circle mt-2">
                        <div class="bg-grey text-start comment" id="replybox{{comment.sno}}">
                          <div class="form-floating">
                            <textarea class="form-control rinput" minlength="3" maxlength="300" name="body" id="rinput"
                              placeholder="Leave a comment here" id="replyarea{{comment.sno}}"></textarea>
                            <label for="replyarea">Add a Reply ✨</label>
                          </div>
                          <div class="d-flex justify-content-end align-content-center">
                            <span class="btn btn-outline-secondary mt-2 mr-2 replycancel replybtn d-none"> Cancel</span>
                            <button type="submit" class="btn btn-outline-primary d-none mt-2 replybtn"><i
                                class="fa fa-commenting-o"></i> Add</button>
                          </div>
                        </div>
                        <br>
                      </div>

                      <input type="hidden" name="post_id" value="{{post.sno}}">
                      <input type="hidden" name="url" value="/b/{{user.username}}/{{post.slug}}">
                      <input type="hidden" name="comsno" value="{{comment.sno}}">
                    </form>
                  </div>

                  {% endif %}
                  <!-- <span class="float-end mx-2 d-inline-block hover-btn"><i class="fa fa-comment-o"></i></span> -->
                  <!-- !All the replies to the comment thread -->
                  <div id="addreply{{comment.sno}}"></div>
                  {% if comment.replies %}
                  {% for reply in comment.replies %}

                  <div class="d-flex my-2 justify-content-center align-content-start align-items-start"
                    style="cursor: auto;">
                    <img src="{{reply.commentor.picture}}" width="35" height="35" class="rounded-circle mt-2">
                    <div class="card bg-grey text-start border-1 comment">
                      <a href="{{url_for('userProfile', username=reply.commentor.username)}}"
                        class="text-muted btn-link text-decoration-none text-sm-start mb-1"
                        style=" margin:0;"><b>{{reply.commentor.firstname}} {{reply.commentor.lastname}} </b>-
                        {{reply.time_ago}}</a>
                      {{reply.body|safe}}
                    </div>
                  </div>
                  {% endfor %}
                  {% endif %}
                </div>
                {% if current_user.is_authenticated %}

                <div class="card-text">
                  <button class="card-text  btn hover-btn reply" id="{{comment.sno}}"><i class="fa fa-comment-o"></i>
                    Reply</button>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
      </section>

    </div>

    <div class="col-lg-3">
      <!-- !User Profile -->

      {{render_user_profile(user, current_user, blogProfile, recommendeds=recommendeds)}}
      <!-- <a class="d-block mx-auto" href="https://www.digitalocean.com/?refcode=14513172b5f4&utm_campaign=Referral_Invite&utm_medium=Referral_Program&utm_source=badge"><img src="https://web-platforms.sfo2.digitaloceanspaces.com/WWW/Badge%202.svg" alt="DigitalOcean Referral Badge" /></a> -->

    </div>


  </div>

</div>
{% endblock body %}
{% block footer %}
<footer class="py-3 bg-light" id="footer">
  <ul class="nav justify-content-center border-bottom pb-3 mb-3">
    <li class="nav-item"><a href="/" class="nav-link px-2 text-muted btn hover-btn">Home</a></li>
    <li class="nav-item"><a href="{{url_for('termsandconditions')}}"
        class="nav-link px-2 text-muted btn hover-btn">Terms and Conditions</a></li>
    <li class="nav-item"><a href="{{url_for('privacy_policy')}}" class="nav-link px-2 btn text-muted hover-btn">Privacy
        Policy</a></li>
  </ul>
  <p class="text-center text-muted">© 2022 Blogsphere, Inc | Made by Fahad</p><a href="mailto:support@blogsphere.top"
    class="nav-link px-2 btn text-muted hover-btn">support@blogsphere.top</a>
</footer>
{% endblock footer %}
{% block script %}
<script src="{{url_for('static',filename='prism/prism.js')}}"></script>
<script src="https://cdn.tiny.cloud/1/8s55fjh97p8z0295i3xgm93498al8v6u61o11kfmzxjk982d/tinymce/6/tinymce.min.js"
  referrerpolicy="origin"></script>
<script>
  $('#bookmark').click(() => {

    if ($('#bookmark').html() == '<i class="fa fa-bookmark"></i>') {
      $('#bookmark').html(`<i class="fa fa-bookmark-o"></i>`)

    } else {
      $('#bookmark').html(`<i class="fa fa-bookmark"></i>`)

    }
    bookmarkReq()
  }
  )
  function copy() {
    // Get the text field
    var copyText = document.getElementById("surl");

    // Select the text field
    copyText.select();
    copyText.setSelectionRange(0, 99999); // For mobile devices

    // Copy the text inside the text field
    navigator.clipboard.writeText(copyText.value);

    // Alert the copied text
    alert("Copied the text: " + copyText.value);
  }

  const bookmarkReq = async () => {
    var myHeaders = new Headers();
    myHeaders.append("Cookie", "Cookie_1=value; Cookie_2=value; session=5a67b465-54b3-4ceb-aff3-496d75f28602");


    var requestOptions = {
      method: 'GET',
      headers: myHeaders,
      credentials: 'include',
      redirect: 'follow'
    };

    await fetch("/bookmark?blogsno={{post.sno}}", requestOptions)
      .then(response => response.json())
      .then(result => {
        let cnt = result["bookmarkCount"]
        $('#bookmarkCount').text(String(cnt))
        console.log(result)
      }
      )
      .catch(error => console.log('error', error));
  }

  document.querySelectorAll("a.delete").forEach(element => {
    element.addEventListener("click", (e) => {
      confirm1 = confirm("Do you really want to delete this blog?")
      if (confirm1) {
        location.href = e.target.id
      }
    })
  })

  $('#sendbtn').click(() => {
    setTimeout(() => {
      document.getElementById('tbody').value = ""
    }, 500)
  })
  $('.replybtn').click(() => {
    setTimeout(() => {
      document.getElementById('rinput').value = ""
    }, 500)
  })


  $('#tbody').focusin(() => {
    $('#sendbtn').removeClass('d-none')
    $('#sendbtn').addClass('d-inline-block')

  })
  $('.rinput').focusin(() => {
    $('.replybtn').removeClass('d-none')
    $('.replybtn').addClass('d-inline-block')

  })


  $('button.reply').click((e) => {
    selector = `#replyinput${e.target.id}`
    $(selector).removeClass('d-none')
    console.log(e)
  })

  $('.replycancel').click(() => {
    $('.replyinput').addClass('d-none')
  })
</script>


{% endblock script %}